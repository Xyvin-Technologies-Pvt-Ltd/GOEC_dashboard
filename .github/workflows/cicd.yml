name: Deploy GOEC Dashboard (PRODUCTION)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Build & Deploy Production Frontend
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install Node & Build React App
      - name: Install & Build
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
        run: |
          npm ci
          CI=false npm run build
          echo "ğŸ‰ Build completed"
          ls -la build/

      # 3ï¸âƒ£ Check SSH connection to AlmaLinux PROD server
      - name: Verify SSH to PROD
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            echo "ğŸ”— Connection OK"
            hostname
            uname -a
            df -h

      # 4ï¸âƒ£ Upload Build folder using rsync
      - name: Upload Build Folder
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: build/
          remote_path: /root/goec-new/
          remote_host: ${{ secrets.PROD_SERVER_IP }}
          remote_user: root
          remote_password: ${{ secrets.PROD_SERVER_PASSWORD }}

      # 5ï¸âƒ£ Deploy on AlmaLinux
      - name: Deploy and Restart NGINX
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment on AlmaLinux..."

            # Ensure nginx installed
            if ! command -v nginx &>/dev/null; then
              echo "ğŸ“¦ Installing nginx..."
              sudo dnf install -y nginx
              sudo systemctl enable nginx
              sudo systemctl start nginx
            fi

            # Backup previous version
            if [ -d "/usr/share/nginx/html/goec-dashboard" ]; then
              echo "ğŸ“¦ Backing up old build..."
              cp -R /usr/share/nginx/html/goec-dashboard /usr/share/nginx/html/goec-dashboard.backup.$(date +%F_%H-%M-%S)
            fi

            echo "ğŸ—‘ Removing old deployment..."
            rm -rf /usr/share/nginx/html/goec-dashboard

            echo "ğŸ“ Creating new deployment folder..."
            mkdir -p /usr/share/nginx/html/goec-dashboard

            echo "ğŸ“¥ Copying files..."
            cp -R /root/goec-new/* /usr/share/nginx/html/goec-dashboard/

            echo "ğŸ” Fixing permissions..."
            chown -R nginx:nginx /usr/share/nginx/html/goec-dashboard
            chmod -R 755 /usr/share/nginx/html/goec-dashboard

            echo "ğŸ§¹ Cleanup..."
            rm -rf /root/goec-new

            echo "ğŸ” Testing nginx config..."
            nginx -t

            echo "â™» Restarting nginx..."
            systemctl restart nginx

           
