name: Deploy GOEC Dashboard (PRODUCTION)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Build & Deploy Production Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install & Build React App
        run: |
          npm ci
          CI=false npm run build
          echo "ğŸ‰ Build Completed"
          ls -la build/

      # Upload build folder using password authentication
      - name: Upload build files to server
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          sshpass -p "${{ secrets.PROD_SERVER_PASSWORD }}" rsync -avzr --delete \
          ./build/ \
          root@${{ secrets.PROD_SERVER_IP }}:/root/goec-new/

      - name: Deploy and Restart NGINX
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            set -e
            echo "ğŸš€ Deploying to AlmaLinux PROD..."

            # Install nginx if missing
            if ! command -v nginx &>/dev/null; then
              echo "ğŸ“¦ Installing nginx..."
              sudo dnf install -y nginx
              sudo systemctl enable --now nginx
            fi

            # Backup existing build
            if [ -d "/usr/share/nginx/html/goec-dashboard" ]; then
              echo "ğŸ“¦ Creating backup..."
              cp -R /usr/share/nginx/html/goec-dashboard /usr/share/nginx/html/goec-dashboard.backup.$(date +%Y%m%d_%H%M%S)
            fi

            echo "ğŸ—‘ Removing old files..."
            rm -rf /usr/share/nginx/html/goec-dashboard
            mkdir -p /usr/share/nginx/html/goec-dashboard

            echo "ğŸ“¥ Deploying new build..."
            cp -R /root/goec-new/* /usr/share/nginx/html/goec-dashboard/

            echo "ğŸ” Fixing permissions..."
            chown -R nginx:nginx /usr/share/nginx/html/goec-dashboard
            chmod -R 755 /usr/share/nginx/html/goec-dashboard

            echo "ğŸ§¹ Cleaning temp folder..."
            rm -rf /root/goec-new

            echo "ğŸ” Testing NGINX config..."
            nginx -t

            echo "â™» Restarting nginx..."
            systemctl restart nginx

            echo "ğŸ‰ Deployment Completed Successfully!"
