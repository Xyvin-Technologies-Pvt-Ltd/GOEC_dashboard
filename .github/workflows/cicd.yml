name: Deploy GOEC Dashboard (PRODUCTION)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Build & Deploy Production Frontend
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Build React App
      - name: Install & Build React App
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - run: |
          npm ci
          CI=false npm run build
          echo "ğŸ‰ Build Completed"
          ls -la build/

      # 3ï¸âƒ£ Upload files using SSH key with rsync
      - name: Upload build files to server via SSH Key
        env:
          SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y rsync

          # Create private key file
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Upload files
          rsync -avzr --delete -e "ssh -o StrictHostKeyChecking=no -i private_key.pem" \
            ./build/ \
            root@${{ secrets.PROD_SERVER_IP }}:/root/goec-new/

      # 4ï¸âƒ£ Deploy on server & restart NGINX
      - name: Deploy & Restart Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Running deployment on AlmaLinux..."

            # Ensure nginx installed
            if ! command -v nginx &>/dev/null; then
              echo "ğŸ“¦ Installing nginx..."
              sudo dnf install -y nginx
              sudo systemctl enable --now nginx
            fi

            # Backup existing build
            if [ -d "/usr/share/nginx/html/goec-dashboard" ]; then
              echo "ğŸ“¦ Creating backup..."
              cp -R /usr/share/nginx/html/goec-dashboard \
                /usr/share/nginx/html/goec-dashboard.backup.$(date +%Y%m%d_%H%M%S)
            fi

            echo "ğŸ—‘ Cleaning old files..."
            rm -rf /usr/share/nginx/html/goec-dashboard
            mkdir -p /usr/share/nginx/html/goec-dashboard

            echo "ğŸ“¥ Deploy new build..."
            cp -R /root/goec-new/* /usr/share/nginx/html/goec-dashboard/

            echo "ğŸ” Setting permissions..."
            chown -R nginx:nginx /usr/share/nginx/html/goec-dashboard
            chmod -R 755 /usr/share/nginx/html/goec-dashboard

            echo "ğŸ§¹ Cleanup..."
            rm -rf /root/goec-new

            echo "ğŸ” Validating config..."
            nginx -t

            echo "â™» Restarting nginx..."
            systemctl restart nginx

            echo "ğŸ‰ Deployment completed successfully!"
