name: Deploy GOEC Dashboard (PRODUCTION)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: Ì∫Ä Build & Deploy Production Frontend
    runs-on: ubuntu-latest

    steps:

      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install Node & Build React App
      - name: Install & Build
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
        run: |
          npm ci
          CI=false npm run build
          echo "Ìæâ Build completed"
          ls -la build/

      # 3Ô∏è‚É£ Check SSH connection to AlmaLinux PROD server
      - name: Verify SSH to PROD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            echo "Ì¥ó Connected to AlmaLinux PROD Server"
            hostname
            uname -a
            df -h

      # 4Ô∏è‚É£ Upload Build folder using rsync
      - name: Upload Build Folder
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: build/
          remote_path: /root/goec-new/
          remote_host: ${{ secrets.PROD_SERVER_IP }}
          remote_user: root
          remote_key: ""
          remote_password: ${{ secrets.PROD_SERVER_PASSWORD }}

      # 5Ô∏è‚É£ Deploy on AlmaLinux
      - name: Deploy and Restart NGINX
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            set -e
            echo "Ì∫Ä Starting deployment on AlmaLinux..."

            # Ensure NGINX exists (if not installed)
            if ! command -v nginx &>/dev/null; then
              echo "Ì≥¶ Installing NGINX..."
              sudo dnf install -y nginx
              sudo systemctl enable nginx
              sudo systemctl start nginx
            fi

            # Backup previous deployment if exists
            if [ -d "/usr/share/nginx/html/goec-dashboard" ]; then
              echo "Ì≥¶ Backup old build..."
              cp -R /usr/share/nginx/html/goec-dashboard /usr/share/nginx/html/goec-dashboard.backup.$(date +%F_%H-%M-%S)
            fi

            echo "Ì∑ë Removing old deployment..."
            rm -rf /usr/share/nginx/html/goec-dashboard

            echo "Ì≥Å Creating new deployment folder..."
            mkdir -p /usr/share/nginx/html/goec-dashboard

            echo "Ì≥• Copying new build..."
            cp -R /root/goec-new/* /usr/share/nginx/html/goec-dashboard/

            echo "Ì¥ê Setting permissions..."
            chown -R nginx:nginx /usr/share/nginx/html/goec-dashboard
            chmod -R 755 /usr/share/nginx/html/goec-dashboard

            echo "Ì∑π Cleaning temp build..."
            rm -rf /root/goec-new

            echo "Ì¥ç Checking nginx config..."
            nginx -t

            echo "‚ôª Restarting nginx..."
            systemctl restart nginx

            echo "Ìæâ Deployment Successful for PROD!"
            echo "Ìºç Website Live: https://${{ secrets.PROD_DOMAIN }}"

