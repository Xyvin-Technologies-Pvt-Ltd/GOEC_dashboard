name: Deploy GOEC Dashboard (PRODUCTION)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸš€ Build & Deploy Production Frontend
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3ï¸âƒ£ Install & Build React App
      - name: Install Dependencies & Build
        run: |
          npm ci
          CI=false npm run build
          echo "ðŸŽ‰ Build completed"
          ls -la build/

      # 4ï¸âƒ£ Verify SSH connectivity
      - name: Verify SSH to PROD
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            echo "ðŸ”— Connection OK"
            hostname
            df -h

      # 5ï¸âƒ£ Upload Build Folder
      - name: Upload Build Folder
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: build/
          remote_path: /root/goec-new/
          remote_host: ${{ secrets.PROD_SERVER_IP }}
          remote_user: root
          remote_password: ${{ secrets.PROD_SERVER_PASSWORD }}

      # 6ï¸âƒ£ Deploy & Restart NGINX
      - name: Deploy and Restart NGINX
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: root
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment on AlmaLinux..."

            if ! command -v nginx &>/dev/null; then
              echo "ðŸ“¦ Installing nginx..."
              sudo dnf install -y nginx
              sudo systemctl enable nginx --now
            fi

            if [ -d "/usr/share/nginx/html/goec-dashboard" ]; then
              echo "ðŸ“¦ Backing up existing deployment..."
              cp -R /usr/share/nginx/html/goec-dashboard /usr/share/nginx/html/goec-dashboard.backup.$(date +%Y%m%d_%H%M%S)
            fi

            rm -rf /usr/share/nginx/html/goec-dashboard
            mkdir -p /usr/share/nginx/html/goec-dashboard
            cp -R /root/goec-new/* /usr/share/nginx/html/goec-dashboard/

            chown -R nginx:nginx /usr/share/nginx/html/goec-dashboard
            chmod -R 755 /usr/share/nginx/html/goec-dashboard
            rm -rf /root/goec-new

            nginx -t
            systemctl restart nginx

            echo "ðŸŽ‰ Production Deployment Successful!"
